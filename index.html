<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>≈Ωrout naƒç√≠t√°n√≠</title>
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@500;700&display=swap" rel="stylesheet">
<style>
  html,body{
    margin:0;height:100%;overflow:hidden;background:#0d0d0d;
    display:flex;align-items:center;justify-content:center;
    font-family:'Oxanium', monospace;color:#00ffc8;user-select:none;touch-action:manipulation;
  }
  canvas{display:block;}
  #lives{
    position:absolute;top:5vh;left:6vw;
    font-size:clamp(20px,4.5vw,26px);
  }
  #timer{
    position:absolute;top:5vh;right:6vw;
    font-size:clamp(20px,4.5vw,26px);
  }
  #countdown{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:clamp(40px,14vw,86px);color:#aafff2;background:rgba(0,0,0,.55);
  }
  #overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;
    background:rgba(0,0,0,.82);gap:.8rem;text-align:center;
    font-size:clamp(22px,5vw,32px);
  }
  #overlay button{
    background:#00ffc8;color:#000;border:none;border-radius:10px;padding:.7em 1.2em;font-size:1rem;font-family:'Orbitron', monospace;
  }
</style>
</head>
<body>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="timer">00:00.000</div>
  <div id="countdown">3</div>
  <div id="overlay">
    <div id="msg">üéâ Hotovo!</div>
    <button onclick="restart()">Zkus to znovu</button>
  </div>
  <canvas id="game"></canvas>

<script>
const TAU=Math.PI*2;
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const livesEl=document.getElementById('lives');
const timerEl=document.getElementById('timer');
const cdEl=document.getElementById('countdown');
const overlay=document.getElementById('overlay');
const msgEl=document.getElementById('msg');

// --- OKAM≈ΩIT√â ZVUKY (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let hitBuffer, missBuffer;

async function loadSound(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  return await audioCtx.decodeAudioData(arrayBuffer);
}

async function initSounds() {
  hitBuffer = await loadSound('https://actions.google.com/sounds/v1/cartoon/pop.ogg');
  missBuffer = await loadSound('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
}

function playSound(buffer) {
  const source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.connect(audioCtx.destination);
  source.start(0);
}
// --- konec zvukov√©ho syst√©mu ---

let W,H,CX,CY,R;
function resize(){
  W=H=Math.min(window.innerWidth,window.innerHeight);
  canvas.width=W; canvas.height=H;
  CX=W/2; CY=H/2; R=W*0.3;
}
resize(); window.addEventListener('resize',resize);

let angle=0,speed=0.025;
let strikes=0,playing=false,canTap=false;
let flash=null,flashTimer=0,shakeFrames=0;
let startTime=0,timeRunning=false,elapsed=0;
let segments=[],order=[],currentIdx=0;

const MIN_LEN=0.35;
const MAX_LEN=0.8;
const HIT_TOL=0.02;

function formatTime(ms){
  const m=Math.floor(ms/60000);
  const s=Math.floor((ms%60000)/1000);
  const x=Math.floor(ms%1000);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(x).padStart(3,'0')}`;
}
function setLives(){
  let s=""; for(let i=0;i<3;i++) s+=(i<3-strikes)?"‚ù§Ô∏è":"ü§ç"; livesEl.textContent=s;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function allFilled(){return segments.every(s=>s.filled);}
function currentTarget(){return segments[order[currentIdx]];}

function generateSegments(){
  segments=[];
  const parts=[];
  let sum=0;
  while(sum<TAU){
    let len=MIN_LEN+Math.random()*(MAX_LEN-MIN_LEN);
    if(sum+len>TAU) len=TAU-sum;
    parts.push(len);
    sum+=len;
  }
  if (parts.length>1 && parts[parts.length-1]<MIN_LEN){
    parts[parts.length-2]+=parts[parts.length-1];
    parts.pop();
  }
  const scale=TAU/sum;
  let start=Math.random()*TAU;
  for(const len of parts){
    const l=len*scale;
    const end=(start+l)%TAU;
    segments.push({start:start,end:end,filled:false});
    start=(start+l)%TAU;
  }
  order=shuffle([...segments.keys()]);
  currentIdx=0;
}

function draw(){
  if(!playing) return;
  ctx.clearRect(0,0,W,H);

  if(shakeFrames>0){
    const amp=W*0.01;
    ctx.save(); ctx.translate((Math.random()-0.5)*amp,(Math.random()-0.5)*amp);
    shakeFrames--;
  }

  ctx.beginPath(); ctx.arc(CX,CY,R,0,TAU);
  ctx.lineWidth=W*0.03;
  ctx.strokeStyle=flash?flash:"#333";
  ctx.stroke();

  ctx.lineWidth=W*0.045; ctx.strokeStyle="#00ffc8";
  for(const s of segments){
    if(!s.filled) continue;
    ctx.beginPath(); ctx.arc(CX,CY,R,s.start,s.end); ctx.stroke();
  }

  const tgt=currentTarget();
  if (tgt && !tgt.filled) {
    ctx.lineWidth=W*0.05;
    ctx.strokeStyle="#555";
    ctx.beginPath(); ctx.arc(CX,CY,R,tgt.start,tgt.end); ctx.stroke();
  }

  // pohybuj√≠c√≠ se bod ‚Äì zelen√Ω s jemn√Ωm b√≠l√Ωm okrajem
  const x = CX + Math.cos(angle) * R;
  const y = CY + Math.sin(angle) * R;
  ctx.beginPath();
  ctx.arc(x, y, W * 0.03, 0, TAU);
  ctx.fillStyle = "#00ffc8";
  ctx.fill();

  // jemn√© ohraniƒçen√≠
  ctx.lineWidth = W * 0.005;
  ctx.strokeStyle = "rgba(255,255,255,0.7)";
  ctx.stroke();


  if(shakeFrames>0) ctx.restore();

  angle=(angle+speed)%TAU;

  if(flashTimer>0){ if(--flashTimer<=0) flash=null; }

  if(timeRunning){
    elapsed=performance.now()-startTime;
    timerEl.textContent=formatTime(elapsed);
  }

  requestAnimationFrame(draw);
}

function inSeg(a,seg){
  a=(a%TAU+TAU)%TAU;
  if(seg.start<seg.end) return a>=seg.start-HIT_TOL && a<=seg.end+HIT_TOL;
  return a>=seg.start-HIT_TOL || a<=seg.end+HIT_TOL;
}

window.addEventListener('pointerdown', e => {
  e.preventDefault();
  if (!playing || !canTap) return;
  const tgt = currentTarget();
  if (!tgt) return;

  if (inSeg(angle, tgt)) {
  tgt.filled = true;
  playSound(hitBuffer);


    if (currentIdx === order.length - 1) {
      tgt.filled = true;
      canTap = false;
      currentIdx++;
      requestAnimationFrame(() => {
        timeRunning = false;
        overlay.style.display = 'flex';
        msgEl.textContent = `üéâ Hotovo! (${formatTime(elapsed)})`;
        playing = false;
      });
    } else {
      currentIdx++;
    }
  } else {
    strikes++;
    setLives();
    playSound(missBuffer);
    flash = "#ff5050"; flashTimer = 15; shakeFrames = 10;
    if (strikes >= 3) {
      timeRunning = false;
      overlay.style.display = 'flex';
      msgEl.textContent = `üòµ Konec hry!`;
      playing = false;
    }
  }
}, { passive: false });

function countdownStart(){
  timerEl.textContent="00:00.000"; elapsed=0; timeRunning=false;
  canTap=false; playing=true;
  cdEl.style.display='flex';
  let n=3; cdEl.textContent=n;
  const tick=()=>{
    if(n>1){ n--; cdEl.textContent=n; setTimeout(tick,700); }
    else{
      cdEl.textContent="GO";
      setTimeout(()=>{
        cdEl.style.display='none';
        startTime=performance.now(); timeRunning=true; canTap=true;
        draw();
      },400);
    }
  };
  setTimeout(tick,700);
}

function restart(){
  angle=0; speed=0.025; strikes=0; flash=null; flashTimer=0; shakeFrames=0;
  setLives(); overlay.style.display='none';
  generateSegments(); countdownStart();
}

setLives(); generateSegments(); initSounds().then(countdownStart);
</script>
</body>
</html>
