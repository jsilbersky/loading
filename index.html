<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <!-- Mobilní viewport + „full screen“ přes notche -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#0e1213">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Snap the Gap</title>

  <style>
    /* =========================
       TÉMA / BARVY
    ========================== */
    :root{
      --bg:#0e1213; --fg:#1f2a2e; --ring:#2a3b40; --neon:#2af5d2;
      --ok:#8fd4ff; --good:#73ffa9; --perfect:#fff7a1; --warn:#ff6b6b;
      /* Bezpečné okraje (iPhone notch) */
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      /* Spolehlivé vh (doplním z JS) */
      --vh: 1vh;
    }

    /* =========================
       ZÁKLAD
    ========================== */
    * { -webkit-tap-highlight-color: transparent; }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:#cfe7e3;
      font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overscroll-behavior: none;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
    }

    /* Plátno přes celou obrazovku (řeší i iOS toolbary) */
    canvas{
      display:block;
      width:100vw;
      /* preferuj 100dvh, fallback na vlastní --vh */
      height:100dvh;
      height:calc(var(--vh) * 100);
      touch-action:manipulation;
    }

    /* HUD = neklikací overlay; paddings respektují safe-area */
    .hud{
    position:fixed; inset:0; pointer-events:none;
    display:flex; flex-direction:column; justify-content:space-between;

    /* Přidán větší horní a spodní padding pro lepší rozestupy */
    padding-top: calc(max(12px, var(--sat)) + 8px);
    padding-bottom: calc(max(12px, var(--sab)) + 10px);
    padding-left: clamp(12px,2.5vmin,24px);
    padding-right: clamp(12px,2.5vmin,24px);
    }

    .row{ display:flex; justify-content:space-between; gap:12px; font-weight:600; letter-spacing:.3px }
    .pill{ background:#0b0f10cc; border:1px solid #1f2a2e; border-radius:999px; padding:.35rem .7rem; backdrop-filter:blur(2px) }

    /* Středový text – výška se doladí v JS podle CY */
    .center{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%); text-align:center; pointer-events:none;
      padding-top: var(--sat);
    }
    .big{ font-size:clamp(24px,6vmin,48px); font-weight:800; text-shadow:0 0 20px #0006 }

    /* =========================
       TLAČÍTKA
       (výchozí: NEviditelné a NEklikací;
        .show => viditelné; .enabled => klikací)
    ========================== */
    .btn{
      position:fixed; left:50%; transform:translateX(-50%);
      width: min(72vw, 320px);
      text-align:center;
      padding:.95rem 1.2rem;
      border-radius:14px;
      font-weight:700; letter-spacing:.4px;
      cursor:pointer; font-family:inherit; text-transform:uppercase;
      backdrop-filter:blur(2px); box-shadow:0 6px 30px #0006;
      opacity:0; pointer-events:none;
      transition:opacity .22s ease, transform .15s ease;
    }
    .btn:active{ transform:translateX(-50%) scale(.97); }

    .btn-main{ background:var(--neon); color:#000; border:none; box-shadow:0 0 20px rgba(42,245,210,.4); }
    .btn-secondary{ background:rgba(42,245,210,.08); color:#b8d4cf; border:1px solid rgba(42,245,210,.15); }

    /* Pozice tlačítek – používají spolehlivé vh a safe-area */
    .btn--again { bottom: calc(28 * var(--vh) + var(--sab)); }
    .btn--share { bottom: calc(18 * var(--vh) + var(--sab)); }

    .btn + .btn{ margin-top:1.2rem; }
    .btn.show{ opacity:1; }
    .btn.enabled{ pointer-events:auto; }

    .fade{ opacity:.65 } .tiny{ font-size:.85rem; opacity:.8 }

    /* ===== HOW TO bubble ===== */
.howto{
  position:fixed; left:50%; transform:translateX(-50%);
  top: 120px; /* skutečnou pozici přepočítá JS v updateHowtoPos() */
  max-width: 280px; z-index:5; pointer-events:none;
  background: rgba(20, 30, 32, 0.92);
  color:#eaf7f4; border:1px solid rgba(42,245,210,.22);
  border-radius:14px; padding:12px 14px; text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,.35); opacity:1; transition:opacity .25s ease;
}
.howto-title{ font-weight:700; letter-spacing:.5px; margin-bottom:4px; font-size:13px; opacity:.9; }
.howto-body{ font-size:14px; line-height:1.35; }
.howto.hide{ opacity:0; }
  </style>
</head>
<body>

  <!-- Plátno -->
  <canvas id="game" aria-label="Snap the Gap"></canvas>

  <!-- HUD (neklikací) -->
  <div class="hud" aria-hidden="true">
    <div class="row">
      <div class="pill" id="score">Score: 0</div>
      <div class="pill" id="best">Record: 0</div>
    </div>

    <!-- Spodní nápověda -->
    <div class="row tiny fade" style="justify-content:center; font-size:.75rem; line-height:1.2;">
  <div class="pill" style="text-align:center;">
    PERFECT +3 • GOOD +2 • OK +1<br>
    Perfect 3 in a row → ×3 • Good 3 in a row → ×2
  </div>
  </div>

  <!-- Středový text (pozici doladí JS) -->
  <div class="center" id="centerText">
    <div class="big" id="bigText">SNAP<br>THE GAP</div>
    <div class="tiny fade" id="subText">Tap anywhere to start</div>
  </div>

    <!-- HOW TO PLAY bubble -->
  <div id="howto" class="howto" aria-live="polite" aria-hidden="false">
  <div class="howto-title">HOW TO PLAY</div>
  <div class="howto-body">
    Tap when the <span style="color:var(--neon);font-weight:700;">triangle</span> is in the middle of the gap.
  </div>
</div>


  <!-- CTA tlačítka -->
  <button class="btn btn-main btn--again" id="againBtn">PLAY AGAIN</button>
  <button class="btn btn-secondary btn--share" id="shareBtn">SHARE SCORE</button>

<script>
(() => {
  /* =========================
     UTIL / KONSTANTY
  ========================== */
  const TAU = Math.PI*2;
  const deg = r=>r*Math.PI/180;
  const now = () => performance.now()/1000;
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const normAngle = a=>{a%=TAU; if(a>Math.PI) a-=TAU; if(a<-Math.PI) a+=TAU; return a;}
  const angleDiff = (a,b)=>normAngle(a-b);
  const rnd = (a,b)=>a + Math.random()*(b-a);

  /* =========================
     CANVAS
  ========================== */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  let CX=0, CY=0, BASE_R=160, THICK=16*DPR;

  function setVHVar(){
    // spolehlivá 1vh = 1% z aktuální vnitřní výšky
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }

  function resize(){
    setVHVar();
    const w = Math.floor(window.innerWidth * DPR);
    const h = Math.floor(window.innerHeight * DPR);
    canvas.width = w; canvas.height = h;

    // CSS výška řešíme přes --vh, ale pro jistotu:
    canvas.style.width = '100vw';
    canvas.style.height = 'calc(var(--vh) * 100)';

    CX = w/2;
    CY = h/2.2;                    // přizvednuto (ergonomie palce)
    BASE_R = Math.min(w, h) / 4.2;
    THICK  = Math.max(10*DPR, Math.min(BASE_R*0.17, 18*DPR));

    // posuň HTML text do stejné výšky
    const centerWrap = document.getElementById('centerText');
    if (centerWrap) {
      centerWrap.style.top = ( (CY / (h||1)) * 100 ) + 'vh';
    }
    updateHowtoPos();
  }

  window.addEventListener('resize', resize, { passive:true });
  // některé prohlížeče (iOS) posílají stabilnější události přes visualViewport
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', resize, { passive:true });
  }

  /* =========================
     HERNÍ STAV
  ========================== */
  let state = 'menu'; // 'menu' | 'play' | 'over'
  let tPrev = now();

  // ring
  let angle = -Math.PI/2;
  let omega = deg(160);
  let gap   = deg(90);
  const gapMin = deg(18);

  // score
  let score = 0;
  let best = Number(localStorage.getItem('stg_best')||0);
  let canTap = true;

  const elScore = document.getElementById('score');
  const elBest  = document.getElementById('best');
  const bigText = document.getElementById('bigText');
  const subText = document.getElementById('subText');
  const againBtn= document.getElementById('againBtn');
  const shareBtn= document.getElementById('shareBtn');
  const howto   = document.getElementById('howto');
  elBest.textContent = `Record: ${best}`;

  // vizuály
  let flash = 0, resultText = null, shake = 0, speedScale = 1, jitterT = 0, freezeT = 0, pendingAngle = null;
  let perfectStreak = 0, goodStreak = 0;

  // hráčův ukazatel
  let playerAngle = -Math.PI/2;
  const minDeltaPlayer = deg(40);

  // UI „pojistka“ – tlačítka povolit až po ukončení miss-tapu
  let uiArmed = false;

  /* =========================
     AUDIO
  ========================== */
  const AudioCtx = window.AudioContext||window.webkitAudioContext;
  let actx = null;

  function beep(type='ok'){
    try{
      if(!actx) actx = new AudioCtx();
      const o = actx.createOscillator();
      const g = actx.createGain();
      const t = actx.currentTime;
      let f = 420;
      if(type==='perfect') f = 840;
      else if(type==='good') f = 620;
      else if(type==='fail') f = 120;
      o.frequency.value = f; o.type = 'sine';
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.5, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + (type==='fail'?0.25:0.12));
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + (type==='fail'?0.26:0.14));
    }catch(e){}
  }

  function streakSound(){
    try{
      if(!actx) actx = new AudioCtx();
      const t = actx.currentTime;
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = 'triangle';
      o.frequency.setValueAtTime(520, t);
      o.frequency.exponentialRampToValueAtTime(1040, t + 0.10);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.28);
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + 0.3);
    }catch(e){}
  }

  function streakSound2(){
    try{
      if(!actx) actx = new AudioCtx();
      const t = actx.currentTime;
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(480, t);
      o.frequency.exponentialRampToValueAtTime(720, t + 0.08);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + 0.24);
    }catch(e){}
  }

  /* =========================
     VSTUPY
  ========================== */
  function onPress(){
    // start jen z menu
    if (state === 'menu'){ handleFirstTapStart(); return; }
    // během hry ignoruj, když je zamknuto
    if (state !== 'play' || !canTap) return;

    const d = Math.abs(angleDiff(playerAngle, angle));
    const inside = d <= gap/2;

    if (inside){
      let grade='ok', points=1, color=getCss('--ok');
      if(d <= deg(2)){ grade='perfect'; points=3; color=getCss('--perfect'); }
      else if(d <= deg(8)){ grade='good'; points=2; color=getCss('--good'); }

      score += points;
      canTap = false;
      elScore.textContent = `Score: ${score}`;

      if (grade==='perfect'){ perfectStreak++; goodStreak=0; }
      else if (grade==='good'){ goodStreak++; perfectStreak=0; }
      else { perfectStreak=0; goodStreak=0; }

      if (perfectStreak===3){
        perfectStreak=0; score = score*3; elScore.textContent = `Score: ${score}`;
        if(navigator.vibrate) navigator.vibrate([25,35,25,35]);
        streakSound(); resultText = { txt:'SCORE ×3', color:getCss('--perfect'), timer:1.0 };
      } else if (goodStreak===3){
        goodStreak=0; score = score*2; elScore.textContent = `Score: ${score}`;
        if(navigator.vibrate) navigator.vibrate([18,22,18]);
        streakSound2(); resultText = { txt:'SCORE ×2', color:getCss('--good'), timer:1.0 };
      }

      flash = 1.0;
      if(navigator.vibrate) navigator.vibrate(grade==='perfect'?30:12);
      beep(grade);
      if(!resultText) resultText = { txt:grade.toUpperCase(), color, timer:0.9 };

      freezeT = 0.50;
      gap = Math.max(gap*0.93, gapMin);
      omega *= 1.10;
      omega *= (1 + (Math.random()*0.12 - 0.06));
      pendingAngle = randomAngleApart(playerAngle, minDeltaPlayer);
    } else {
      gameOver();
    }
  }

  canvas.addEventListener('pointerdown', onPress, { passive:true });
  window.addEventListener('keydown', e=>{
    if (e.repeat) return;
    if (e.code==='Space' || e.code==='Enter') onPress();
  });

  // Tlačítka – reagují jen pokud je po „game over“
  againBtn.addEventListener('click', (e)=>{
    if (!uiArmed || state!=='over') { e.preventDefault(); e.stopPropagation(); return; }
    againBtn.classList.remove('show','enabled');
    shareBtn.classList.remove('show','enabled');
    startGame();
  });

  shareBtn.addEventListener('click', async (e)=>{
    if (!uiArmed || state!=='over') { e.preventDefault(); e.stopPropagation(); return; }
    const shareText = `Snap the Gap — Score ${score}`;
    const shareData = { title:'Snap the Gap', text:shareText, url:location.href };
    try{
      if (navigator.share) await navigator.share(shareData);
      else if (navigator.clipboard){
        await navigator.clipboard.writeText(shareText);
        const prev = shareBtn.textContent;
        shareBtn.textContent = 'COPIED!';
        setTimeout(()=> shareBtn.textContent = prev, 1200);
      } else { alert(shareText); }
    }catch(e){}
  });

  function randomAngleApart(prev, minDelta){
    let a = prev, tries = 0;
    do { a = rnd(-Math.PI, Math.PI); tries++; if(tries>50) break; }
    while (Math.abs(angleDiff(a, prev)) < minDelta);
    return a;
  }

  // —— HOW TO overlay helpers ——

// Umístit bublinu nad špičku trojúhelníku
function updateHowtoPos(){
  if(!howto) return;

  // výška horních pilulek
  const topHUD = 60 * DPR;          // odhad výšky řádku s pilulkami
  const spaceTop = topHUD / DPR;    // přepočet na CSS px
  const circleTop = (CY - BASE_R) / DPR;  // horní okraj kruhu

  // výška bubliny: přesně uprostřed mezi horními pilulkami a horním okrajem kruhu
  let topPx = spaceTop + (circleTop - spaceTop) * 0.4;

  // ochrana proti překrytí (nepřes horní hranu)
  topPx = Math.max(12, topPx);

  howto.style.top = `${topPx}px`;
}

// Na start obrazovky srovnat šipku doprostřed mezery („like this“)
function alignIdleLikeThis(){
  playerAngle = angle; // střed mezery = 'angle'
}

// Zobrazit bublinu
function maybeShowHowto(){
  if(!howto) return;
  howto.classList.remove('hide');   // vždy ukázat na startu
  alignIdleLikeThis();
  updateHowtoPos();
}


// První tap na startu: schovat bublinu a začít hru
function handleFirstTapStart(){
  if(howto) howto.classList.add('hide');  // schovej jen pro právě startovanou hru
  playMusic();
  startGame();
}

  /* =========================
     FLOW
  ========================== */
  function startGame(){
    fadeInMusic();
    if(howto) howto.classList.add('hide');
    state='play';
    score=0; elScore.textContent='Score: 0';
    angle = -Math.PI/2; omega = deg(160); gap = deg(90);
    resultText = null; flash=0; shake=0; speedScale=1; jitterT=0; freezeT=0;
    playerAngle = -Math.PI/2;

    uiArmed = false;
    againBtn.classList.remove('show','enabled');
    shareBtn.classList.remove('show','enabled');

    bigText.textContent=''; subText.textContent='';
  }

  function gameOver(){
    fadeOutMusic();
    state='over';
    if(navigator.vibrate) navigator.vibrate([20,40,35]);
    beep('fail'); shake=12;

    best = Math.max(best, score);
    localStorage.setItem('stg_best', best);
    elBest.textContent = `Record: ${best}`;

    bigText.innerHTML = `GAME OVER<br><span style="font-weight:700;color:#9fd">Score: ${score}</span>`;

    // 1) hned zobraz tlačítka (ale NEklikatelná)
    againBtn.classList.add('show'); shareBtn.classList.add('show');
    againBtn.classList.remove('enabled'); shareBtn.classList.remove('enabled');

    uiArmed = false;

    // 2) spolknout „dojezd“ miss-tapu a až pak odjistit UI
    const swallow = ev => { ev.stopPropagation(); ev.preventDefault(); };
    window.addEventListener('click', swallow, true);
    window.addEventListener('pointerup', swallow, true);

    setTimeout(()=>{
      window.removeEventListener('click', swallow, true);
      window.removeEventListener('pointerup', swallow, true);
      uiArmed = true;
      againBtn.classList.add('enabled');
      shareBtn.classList.add('enabled');
    }, 350); // můžeš upravit (200–400 ms)
  }

  /* =========================
     RENDER
  ========================== */
  function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function drawTriangleAtAngle(a, rPath){
    const offset = THICK/2 + 4*DPR;
    const rx = CX + Math.cos(a) * (rPath + offset);
    const ry = CY + Math.sin(a) * (rPath + offset);
    const base = THICK * 0.9;
    const height = THICK * 1.15;

    ctx.save();
    ctx.translate(rx, ry);
    ctx.rotate(a + Math.PI);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(-height, -base/2);
    ctx.lineTo(-height,  base/2);
    ctx.closePath();
    ctx.fillStyle = getCss('--neon');
    ctx.shadowColor = getCss('--neon'); ctx.shadowBlur = 12;
    ctx.fill(); ctx.shadowBlur = 0;
    ctx.restore();
  }

  function render(dt){
    let sx=0, sy=0;
    if(shake>0){
      sx=(Math.random()*2-1)*shake; sy=(Math.random()*2-1)*shake;
      shake*=0.86; if(shake<0.1) shake=0;
    }

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(sx,sy);

    // drobný jitter rychlosti
    jitterT -= dt;
    if(jitterT<=0){
      jitterT = 0.18 + Math.random()*0.22;
      const spike = Math.random() < 0.08;
      speedScale = spike ? (1.45 + Math.random()*0.25) : (0.92 + Math.random()*0.2);
    }

    if(state==='play'){
      if (freezeT > 0){
        freezeT -= dt;
        if (freezeT <= 0 && pendingAngle !== null){
          playerAngle = pendingAngle; pendingAngle = null; canTap = true;
        }
      } else {
        angle += omega * dt * speedScale;
      }
    }

    const R = BASE_R, thick = THICK;
    const centerA = angle, a1 = centerA - gap/2, a2 = centerA + gap/2;

    // základní kruh
    ctx.strokeStyle = getCss('--ring');
    ctx.lineWidth = thick; ctx.lineCap='round';
    ctx.beginPath(); ctx.arc(CX,CY,R,0,TAU); ctx.stroke();

    // neon bez mezery
    ctx.strokeStyle = getCss('--neon');
    ctx.shadowColor = getCss('--neon'); ctx.shadowBlur=20;
    ctx.beginPath(); ctx.arc(CX,CY,R, a2, a1+TAU); ctx.stroke();
    ctx.shadowBlur = 0;

    // hráčův trojúhelník
    drawTriangleAtAngle(playerAngle, R);

    // textový výsledek
    if(resultText){
      resultText.timer -= dt;
      const alpha = clamp(resultText.timer/0.7,0,1);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = resultText.color;
      ctx.font = `700 ${Math.round(28*DPR)}px system-ui,Segoe UI,Roboto`;
      ctx.textAlign='center';
      ctx.fillText(resultText.txt, CX, CY - R - 28*DPR);
      ctx.globalAlpha = 1;
      if(resultText.timer<=0) resultText=null;
    }

    // záblesk
    if(flash>0){
      const rad = R + (1-flash)*R*0.4;
      ctx.strokeStyle = getCss('--neon'); ctx.globalAlpha = flash*0.65;
      ctx.lineWidth = thick*0.6*(flash);
      ctx.beginPath(); ctx.arc(CX,CY,rad,0,TAU); ctx.stroke();
      ctx.globalAlpha = 1; flash -= dt*2.2; if(flash<0) flash=0;
    }

    ctx.restore();
  }

  /* =========================
     SMYČKA
  ========================== */
  function tick(){ const t=now(); let dt=t-tPrev; tPrev=t; dt=Math.min(0.033,Math.max(0.001,dt)); render(dt); requestAnimationFrame(tick); }

  /* =========================
     INIT
  ========================== */
  resize(); render(0); requestAnimationFrame(tick);
  bigText.textContent = 'SNAP THE GAP';
  subText.textContent = 'Tap anywhere to start';
  maybeShowHowto();
  updateHowtoPos();
  alignIdleLikeThis();


  // iOS/Chrome: první tap inicializuje AudioContext
  window.addEventListener('pointerdown', ()=>{ if(!actx){ try{ actx=new AudioCtx(); }catch(e){} } }, {once:true, passive:true});
})();

/* =========================
   BACKGROUND MUSIC
========================== */
let bgMusic = null;
let fadeInterval = null;

function playMusic() {
  if (!bgMusic) {
    bgMusic = new Audio('music.mp3');
    bgMusic.loop = true;
    bgMusic.volume = 0.25; // tichá úroveň
  }
  // restartuj, pokud byla pauznutá
  if (bgMusic.paused) bgMusic.play().catch(()=>{});
}

function fadeOutMusic(duration = 1500) {
  if (!bgMusic) return;
  const startVol = bgMusic.volume;
  const steps = 30;
  const stepTime = duration / steps;
  let i = 0;
  clearInterval(fadeInterval);
  fadeInterval = setInterval(() => {
    i++;
    bgMusic.volume = Math.max(0, startVol * (1 - i / steps));
    if (i >= steps) {
      clearInterval(fadeInterval);
      bgMusic.pause();
      bgMusic.currentTime = 0; // reset pozice
      bgMusic.volume = startVol; // připrav pro další hru
    }
  }, stepTime);
}

function fadeInMusic(duration = 1200) {
  if (!bgMusic) return;
  bgMusic.volume = 0;
  bgMusic.play().catch(()=>{});
  const targetVol = 0.4;
  const steps = 30;
  const stepTime = duration / steps;
  let i = 0;
  clearInterval(fadeInterval);
  fadeInterval = setInterval(() => {
    i++;
    bgMusic.volume = Math.min(targetVol, (targetVol * i) / steps);
    if (i >= steps) clearInterval(fadeInterval);
  }, stepTime);
}

</script>
</body>
</html>
