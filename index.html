<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <!-- Mobilní viewport + „full screen“ přes notche -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#0e1213">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Loading Rush</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =========================
       TÉMA / BARVY
    ========================== */
    :root {
  --bg:#0e1213;
  --fg:#1f2a2e;
  --ring:#2a3b40;
  --neon:#2af5d2;
  --ok:#8fd4ff;
  --good:#73ffa9;
  --perfect:#fff7a1;
  --warn:#ff6b6b;

/* vyšší trojúhelník (dolů) */
.icon-tri{
  display:inline-block;
  width:1.2em;
  height:1.8em;           /* protáhlé jako ve hře */
  vertical-align:-0.42em;
  margin:0 .08em;
}
.icon-tri svg{
  display:block; width:100%; height:100%;
  fill:var(--neon);
  filter: drop-shadow(0 0 6px rgba(42,245,210,.55));
}

/* titulek uprostřed kruhu – obě slova stejně velká */
.title-stack{
  display:inline-block;
  line-height:1.0;
  font-weight:800;
  letter-spacing:.5px;
  text-transform:uppercase;
}

/* stejná velikost pro LOADING i RUSH */
.title-loading,
.title-rush{
  display:block;
  font-size:clamp(22px, 7.2vmin, 38px);
  opacity:1;               
}


/* malý podtitul (tap to start) */
.subtitle{ margin-top:.35rem; font-size:clamp(10px, 3.2vmin, 11px); letter-spacing:.35px; opacity:.8; }

  /* Bezpečné okraje (iPhone notch) */
  --sat: env(safe-area-inset-top, 0px);
  --sab: env(safe-area-inset-bottom, 0px);

  /* Spolehlivé vh (doplním z JS) */
  --vh: 1vh;

  /* Písmo a typografická škála (clamp = responzivní) */
  --font-sans: "Oxanium", ui-sans-serif, system-ui, -apple-system, "Segoe UI",
               Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

  --fs-2xl: clamp(28px, 7vmin, 44px);
  --fs-xl:  clamp(18px, 4.8vmin, 24px);
  --fs-lg:  clamp(16px, 3.4vmin, 18px);
  --fs-md:  clamp(14px, 2.8vmin, 16px);
  --fs-sm:  clamp(13px, 2.4vmin, 14px);
  --fs-xs:  clamp(12px, 2.0vmin, 13px);

  --canvas-result: 26;
}

    /* =========================
       ZÁKLAD
    ========================== */
    * { -webkit-tap-highlight-color: transparent; }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:#cfe7e3;
      font-family: var(--font-sans);
      font-size: var(--fs-md);
      overscroll-behavior: none;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
    }

    /* Plátno přes celou obrazovku (řeší i iOS toolbary) */
    canvas{
  display:block;
  width:100vw;
  /* 1) prefer dvh, 2) fallback na vlastní --vh */
  height: calc(var(--vh, 1dvh) * 100);
  touch-action:manipulation;
}


    /* HUD = neklikací overlay; paddings respektují safe-area */
    .hud{
    position:fixed; inset:0; pointer-events:none;
    display:flex; flex-direction:column; justify-content:space-between;

    /* Přidán větší horní a spodní padding pro lepší rozestupy */
    padding-top: calc(max(12px, var(--sat)) + 8px);
    padding-bottom: calc(max(12px, var(--sab)) + 10px);
    padding-left: clamp(12px,2.5vmin,24px);
    padding-right: clamp(12px,2.5vmin,24px);
    }

    .row{ display:flex; justify-content:space-between; gap:12px; font-weight:600; letter-spacing:.3px }
    .pill{ 
    background:#0b0f10cc; border:1px solid #1f2a2e; border-radius:999px;
    padding:.35rem .7rem; backdrop-filter:blur(2px);
    font-size: var(--fs-sm); font-weight:700; letter-spacing:.3px;
    }


    /* Středový text – výška se doladí v JS podle CY */
    .center{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%); text-align:center; pointer-events:none;
    }
    .big{ font-size: var(--fs-lg); line-height: 1.15; letter-spacing: .4px; font-weight:800; text-shadow:0 0 20px #0006 }

    /* =========================
       TLAČÍTKA
       (výchozí: NEviditelné a NEklikací;
        .show => viditelné; .enabled => klikací)
    ========================== */
    .btn{
      position:fixed; left:50%; transform:translateX(-50%);
      width: min(50vw, 250px);
      text-align:center;
      padding:.95rem 1.2rem;
      border-radius:15px;
      font-weight:700; letter-spacing:.4px;
      cursor:pointer; font-family:inherit; text-transform:uppercase;
      backdrop-filter:blur(2px); box-shadow:0 6px 30px #0006;
      opacity:0; pointer-events:none;
      transition:opacity .22s ease, transform .15s ease;
      font-size: 1.1rem;      /* zvětšení textu */
      line-height: 1.15;      /* ať je text opticky uprostřed */
      white-space: nowrap;    /* aby se text nelámal na 2 řádky */
      padding: 1.05rem 1.3rem;/* lehce větší tap target */

    }
    .btn:active{ transform:translateX(-50%) scale(.97); }

    .btn-main{ background:var(--neon); color:#000; border:none; box-shadow:0 0 20px rgba(42,245,210,.4); }
    .btn-secondary{ background:rgba(42,245,210,.08); color:#b8d4cf; border:1px solid rgba(42,245,210,.15); }

    /* Pozice tlačítek – používají spolehlivé vh a safe-area */
    .btn--again { bottom: calc(28 * var(--vh) + var(--sab)); }
    .btn--share { bottom: calc(18 * var(--vh) + var(--sab)); }

    .btn + .btn{ margin-top:1.2rem; }
    .btn.show{ opacity:1; }
    .btn.enabled{ pointer-events:auto; }

    .fade{ opacity:.65 } .tiny{ font-size: var(--fs-xs); opacity:.8 }

    /* ===== HOW TO bubble ===== */
.howto{
  position:fixed; left:50%; transform:translateX(-50%);
  top: 120px; /* skutečnou pozici přepočítá JS v updateHowtoPos() */
  width: clamp(220px, 50vw, 220px);
  max-width: none; z-index:5; pointer-events:none;
  background: rgba(20, 30, 32, 0.92);
  color:#eaf7f4; border:1px solid rgba(42,245,210,.22);
  border-radius:14px; padding:12px 14px; text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,.35); opacity:1; transition:opacity .25s ease;
}
.howto-title{ font-weight:700; letter-spacing:.5px; margin-bottom:4px; font-size: var(--fs-xs); opacity:.9; }
.howto-body{ font-size: var(--fs-sm); line-height:1.35; }
.howto.hide{ opacity:0; }
  </style>
</head>
<body>

  <!-- Plátno -->
  <canvas id="game" aria-label="Snap the Gap"></canvas>

  <!-- HUD (neklikací) -->
  <div class="hud">
    <div class="row">
      <div class="pill" id="score">Score: 0</div>
      <div class="pill" id="best">Record: 0</div>
    </div>

    <!-- Spodní nápověda -->
    <div class="row tiny fade" style="justify-content:center; font-size:.75rem; line-height:1.2; opacity: 0.5;">
  <div class="pill" style="text-align:center;">
    PERFECT +3 • GOOD +2 • OK +1<br>
    Perfect 3 in a row → ×3 • Good 3 in a row → ×2
  </div>
  </div>

<!-- Středový text (pozici doladí JS) -->
<div class="center" id="centerText">
  <div class="big" id="bigText">
    <span class="title-stack">
      <span class="title-loading">LOADING</span>
      <span class="title-rush">RUSH</span>
    </span>
  </div>
  <div class="subtitle" id="subText">TAP TO START</div>
</div>


    <!-- HOW TO PLAY bubble -->
  <div id="howto" class="howto" aria-live="polite">
  <div class="howto-title">HOW TO PLAY</div>
  <div class="howto-body">
Tap when
<span class="icon-tri" role="img" aria-label="triangle">
  <svg viewBox="0 0 32 44" aria-hidden="true" focusable="false" preserveAspectRatio="xMidYMid meet">
    <!-- špička dolů, protáhlý tvar -->
    <path d="M16 42 L2 6 H30 Z"/>
  </svg>
</span>
is at center of the gap.<br>
Closer = more points.
  </div>
</div>


  <!-- CTA tlačítka -->
  <button class="btn btn-main btn--again" id="againBtn">PLAY AGAIN</button>
  <button class="btn btn-secondary btn--share" id="shareBtn">SHARE SCORE</button>

<script>
(() => {
  /* =========================
     UTIL / KONSTANTY
  ========================== */
  const TAU = Math.PI*2;
  const deg = r=>r*Math.PI/180;
  const now = () => performance.now()/1000;
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const normAngle = a=>{a%=TAU; if(a>Math.PI) a-=TAU; if(a<-Math.PI) a+=TAU; return a;}
  const angleDiff = (a,b)=>normAngle(a-b);
  const rnd = (a,b)=>a + Math.random()*(b-a);

  /* =========================
     CANVAS
  ========================== */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  let CX=0, CY=0, BASE_R=160, THICK=16*DPR;

  function setVHVar(){
  const h = (window.visualViewport && window.visualViewport.height)
    ? window.visualViewport.height
    : window.innerHeight;
  const vh = h * 0.01;
  document.documentElement.style.setProperty('--vh', vh + 'px');
}


  function resize(){
    setVHVar();
    const w = Math.floor(window.innerWidth * DPR);
    const h = Math.floor(window.innerHeight * DPR);
    canvas.width = w; canvas.height = h;

    // CSS výška řešíme přes --vh, ale pro jistotu:
    canvas.style.width = '100vw';
    canvas.style.height = 'calc(var(--vh, 1dvh) * 100)';


    CX = w/2;
    CY = h/2.2;                    // přizvednuto (ergonomie palce)
    BASE_R = Math.min(w, h) / 4.2;
    THICK  = Math.max(10*DPR, Math.min(BASE_R*0.20, 22*DPR));

    // posuň HTML text do stejné výšky
    const centerWrap = document.getElementById('centerText');
    if (centerWrap) {
      centerWrap.style.top = (CY / DPR) + 'px';
    }
    updateHowtoPos();
  }

  window.addEventListener('resize', resize, { passive:true });
  // některé prohlížeče (iOS) posílají stabilnější události přes visualViewport
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', resize, { passive:true });
  }

  /* =========================
     HERNÍ STAV
  ========================== */
  let state = 'menu'; // 'menu' | 'play' | 'over'
  let tPrev = now();

  // ring
  let angle = -Math.PI/2;
  let omega = deg(160);
  let gap   = deg(90);
  const gapMin = deg(18);

  // score
  let score = 0;
  let best = Number(localStorage.getItem('stg_best')||0);
  let canTap = true;

  const elScore = document.getElementById('score');
  const elBest  = document.getElementById('best');
  const bigText = document.getElementById('bigText');
  const subText = document.getElementById('subText');
  const againBtn= document.getElementById('againBtn');
  const shareBtn= document.getElementById('shareBtn');
  const howto   = document.getElementById('howto');
  elBest.textContent = `Record: ${best}`;

  // vizuály
  let flash = 0, resultText = null, shake = 0, speedScale = 1, jitterT = 0, freezeT = 0, pendingAngle = null;
  let perfectStreak = 0, goodStreak = 0;

  // hráčův ukazatel
  let playerAngle = -Math.PI/2;
  const minDeltaPlayer = deg(40);

  // UI „pojistka“ – tlačítka povolit až po ukončení miss-tapu
  let uiArmed = false;

  /* =========================
     AUDIO
  ========================== */
  const AudioCtx = window.AudioContext||window.webkitAudioContext;
  let actx = null;

  function beep(type='ok'){
    try{
      if(!actx) actx = new AudioCtx();
      const o = actx.createOscillator();
      const g = actx.createGain();
      const t = actx.currentTime;
      let f = 420;
      if(type==='perfect') f = 840;
      else if(type==='good') f = 620;
      else if(type==='fail') f = 220;
      o.frequency.value = f; o.type = 'sine';
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.5, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + (type==='fail'?0.25:0.12));
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + (type==='fail'?0.26:0.14));
    }catch(e){}
  }

  function streakSound(){
    try{
      if(!actx) actx = new AudioCtx();
      const t = actx.currentTime;
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = 'triangle';
      o.frequency.setValueAtTime(520, t);
      o.frequency.exponentialRampToValueAtTime(1040, t + 0.10);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.28);
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + 0.3);
    }catch(e){}
  }

  function streakSound2(){
    try{
      if(!actx) actx = new AudioCtx();
      const t = actx.currentTime;
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(480, t);
      o.frequency.exponentialRampToValueAtTime(720, t + 0.08);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.7, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);
      o.connect(g); g.connect(actx.destination);
      o.start(t); o.stop(t + 0.24);
    }catch(e){}
  }

  /* =========================
     VSTUPY
  ========================== */
function onPress(){
  // start jen z menu
  if (state === 'menu'){ handleFirstTapStart(); return; }
  // během hry ignoruj, když je zamknuto
  if (state !== 'play' || !canTap) return;

  const d = Math.abs(angleDiff(playerAngle, angle));
  const inside = d <= gap/2;

  if (inside){
    let grade='ok', points=1, color=getCss('--ok');
    if(d <= deg(2)){ grade='perfect'; points=3; color=getCss('--perfect'); }
    else if(d <= deg(8)){ grade='good'; points=2; color=getCss('--good'); }

    score += points;
    canTap = false;
    elScore.textContent = `Score: ${score}`;

    // správa sérií
    if (grade==='perfect'){ perfectStreak++; goodStreak=0; }
    else if (grade==='good'){ goodStreak++; perfectStreak=0; }
    else { perfectStreak=0; goodStreak=0; }

    // zda se udělil násobič
    let streakAwarded = false;

    if (perfectStreak === 3){
      perfectStreak = 0;
      score = score * 3;
      elScore.textContent = `Score: ${score}`;
      if(navigator.vibrate) navigator.vibrate([25,35,25,35]);
      streakSound();
      resultText = { txt:'SCORE ×3', color:getCss('--perfect'), timer:1.0 };
      streakAwarded = true;
    } else if (goodStreak === 3){
      goodStreak = 0;
      score = score * 2;
      elScore.textContent = `Score: ${score}`;
      if(navigator.vibrate) navigator.vibrate([18,22,18]);
      streakSound2();
      resultText = { txt:'SCORE ×2', color:getCss('--good'), timer:1.0 };
      streakAwarded = true;
    }

    // efekty zásahu
    flash = 1.0;
    if(navigator.vibrate) navigator.vibrate(grade==='perfect'?30:12);
    beep(grade);

    // !!! nepřepisuj text série
    if (!streakAwarded){
      resultText = { txt: grade.toUpperCase(), color, timer: 0.9 };
    }

    // freeze + zvýšení obtížnosti
    freezeT = 0.50;
    gap = Math.max(gap*0.93, gapMin);
    omega *= 1.10;
    omega *= (1 + (Math.random()*0.12 - 0.06));
    pendingAngle = randomAngleApart(playerAngle, minDeltaPlayer);

  } else {
    gameOver();
  }
}

  canvas.addEventListener('pointerdown', onPress, { passive:true });
  window.addEventListener('keydown', e=>{
    if (e.repeat) return;
    if (e.code==='Space' || e.code==='Enter') onPress();
  });

  // Tlačítka – reagují jen pokud je po „game over“
  againBtn.addEventListener('click', (e)=>{
    if (!uiArmed || state!=='over') { e.preventDefault(); e.stopPropagation(); return; }
    againBtn.classList.remove('show','enabled');
    shareBtn.classList.remove('show','enabled');
    startGame();
  });

  shareBtn.addEventListener('click', async (e)=>{
    if (!uiArmed || state!=='over') { e.preventDefault(); e.stopPropagation(); return; }
    const shareText = `Snap the Gap — Score ${score}`;
    const shareData = { title:'Snap the Gap', text:shareText, url:location.href };
    try{
      if (navigator.share) await navigator.share(shareData);
      else if (navigator.clipboard){
        await navigator.clipboard.writeText(shareText);
        const prev = shareBtn.textContent;
        shareBtn.textContent = 'COPIED!';
        setTimeout(()=> shareBtn.textContent = prev, 1200);
      } else { alert(shareText); }
    }catch(e){}
  });

  function randomAngleApart(prev, minDelta){
    let a = prev, tries = 0;
    do { a = rnd(-Math.PI, Math.PI); tries++; if(tries>50) break; }
    while (Math.abs(angleDiff(a, prev)) < minDelta);
    return a;
  }

  // —— HOW TO overlay helpers ——

// Umístit bublinu nad špičku trojúhelníku
function updateHowtoPos(){
  if(!howto) return;

  // výška horních pilulek
  const topHUD = 60 * DPR;          // odhad výšky řádku s pilulkami
  const spaceTop = topHUD / DPR;    // přepočet na CSS px
  const circleTop = (CY - BASE_R) / DPR;  // horní okraj kruhu

  // výška bubliny: přesně uprostřed mezi horními pilulkami a horním okrajem kruhu
  let topPx = spaceTop + (circleTop - spaceTop) * 0.4;

  // ochrana proti překrytí (nepřes horní hranu)
  topPx = Math.max(12, topPx);

  howto.style.top = `${topPx}px`;
}

// Na start obrazovky srovnat šipku doprostřed mezery („like this“)
function alignIdleLikeThis(){
  playerAngle = angle; // střed mezery = 'angle'
}

// Zobrazit bublinu
function maybeShowHowto(){
  if(!howto) return;
  howto.classList.remove('hide');   // vždy ukázat na startu
  alignIdleLikeThis();
  updateHowtoPos();
}


// První tap na startu: schovat bublinu a začít hru
function handleFirstTapStart(){
  if(howto) howto.classList.add('hide');  // schovej jen pro právě startovanou hru
  playMusic();
  startGame();
}

function showHomeTitle(){
  if(!bigText) return;
  bigText.innerHTML =
    '<span class="title-stack">' +
      '<span class="title-loading">LOADING</span>' +
      '<span class="title-rush">RUSH</span>' +
    '</span>';
  if (subText) subText.textContent = 'TAP ANYWHERE TO START';
}

  /* =========================
     FLOW
  ========================== */
  function startGame(){
    fadeInMusic();

    if(howto) howto.classList.add('hide');
    state='play';

    // ★ RESET pro novou hru (aby se nepřenášely streaky a zámky)
    score = 0; 
    elScore.textContent='Score: 0';

    angle = -Math.PI/2; 
    omega = deg(160); 
    gap = deg(90);

    resultText = null; 
    flash=0; 
    shake=0; 
    speedScale=1; 
    jitterT=0; 
    freezeT=0; 
    pendingAngle = null;            // ★
    playerAngle = -Math.PI/2;

    perfectStreak = 0;              // ★
    goodStreak = 0;                 // ★
    canTap = true;                  // ★

    uiArmed = false;
    againBtn.classList.remove('show','enabled');
    shareBtn.classList.remove('show','enabled');

    bigText.textContent='';
    if (subText) subText.textContent = '';
  }

  function gameOver(){
    fadeOutMusic();
    // Krátký červený záblesk
    document.documentElement.style.setProperty('--neon', '#ff6b6b'); // červená
    setTimeout(() => {
    document.documentElement.style.setProperty('--neon', '#2af5d2'); // zpět na původní zelenou
    }, 250);

    state='over';
    if(navigator.vibrate) navigator.vibrate([20,40,35]);
    beep('fail'); shake=12;

    best = Math.max(best, score);
    localStorage.setItem('stg_best', best);
    elBest.textContent = `Record: ${best}`;

    bigText.innerHTML = `GAME OVER<br><span style="font-weight:700;color:#9fd">Score: ${score}</span>`;

    // 1) hned zobraz tlačítka (ale NEklikatelná)
    againBtn.classList.add('show'); shareBtn.classList.add('show');
    againBtn.classList.remove('enabled'); shareBtn.classList.remove('enabled');

    uiArmed = false;

    // 2) spolknout „dojezd“ miss-tapu a až pak odjistit UI
    const swallow = ev => { ev.stopPropagation(); ev.preventDefault(); };
    window.addEventListener('click', swallow, true);
    window.addEventListener('pointerup', swallow, true);

    setTimeout(()=>{
      window.removeEventListener('click', swallow, true);
      window.removeEventListener('pointerup', swallow, true);
      uiArmed = true;
      againBtn.classList.add('enabled');
      shareBtn.classList.add('enabled');
    }, 350); // můžeš upravit (200–400 ms)
  }

  /* =========================
     RENDER
  ========================== */
  function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function drawTriangleAtAngle(a, rPath){
    const offset = THICK/2 + 4*DPR;
    const rx = CX + Math.cos(a) * (rPath + offset);
    const ry = CY + Math.sin(a) * (rPath + offset);
    const base = THICK * 0.9;
    const height = THICK * 1.15;

    ctx.save();
    ctx.translate(rx, ry);
    ctx.rotate(a + Math.PI);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(-height, -base/2);
    ctx.lineTo(-height,  base/2);
    ctx.closePath();
    ctx.fillStyle = getCss('--neon');
    ctx.shadowColor = getCss('--neon'); ctx.shadowBlur = 10;
    ctx.fill(); ctx.shadowBlur = 0;
    ctx.restore();
  }

  function render(dt){
    let sx=0, sy=0;
    if(shake>0){
      sx=(Math.random()*2-1)*shake; sy=(Math.random()*2-1)*shake;
      shake*=0.86; if(shake<0.1) shake=0;
    }

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(sx,sy);

    // drobný jitter rychlosti
    jitterT -= dt;
    if(jitterT<=0){
      jitterT = 0.18 + Math.random()*0.22;
      const spike = Math.random() < 0.08;
      speedScale = spike ? (1.45 + Math.random()*0.25) : (0.92 + Math.random()*0.2);
    }

    if(state==='play'){
      if (freezeT > 0){
        freezeT -= dt;
        if (freezeT <= 0 && pendingAngle !== null){
          playerAngle = pendingAngle; pendingAngle = null; canTap = true;
        }
      } else {
        angle += omega * dt * speedScale;
      }
    }

    const R = BASE_R, thick = THICK;
    const centerA = angle, a1 = centerA - gap/2, a2 = centerA + gap/2;

    // základní kruh
    ctx.strokeStyle = getCss('--ring');
    ctx.lineWidth = thick; ctx.lineCap='round';
    ctx.beginPath(); ctx.arc(CX,CY,R,0,TAU); ctx.stroke();

    // neon bez mezery
    ctx.strokeStyle = getCss('--neon');
    ctx.shadowColor = getCss('--neon'); ctx.shadowBlur=15;
    ctx.beginPath(); ctx.arc(CX,CY,R, a2, a1+TAU); ctx.stroke();
    ctx.shadowBlur = 0;

    // hráčův trojúhelník
    drawTriangleAtAngle(playerAngle, R);

    // textový výsledek
    if(resultText){
      resultText.timer -= dt;
      const alpha = clamp(resultText.timer/0.7,0,1);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = resultText.color;
      ctx.font = `800 ${Math.round(parseInt(getCss('--canvas-result')||'26',10)*DPR)}px "Oxanium", ui-sans-serif, system-ui, "Segoe UI", Roboto`;
      ctx.textAlign='center';
      ctx.fillText(resultText.txt, CX, CY - R - 40*DPR);
      ctx.globalAlpha = 1;
      if(resultText.timer<=0) resultText=null;
    }

    // záblesk
    if(flash>0){
      const rad = R + (1-flash)*R*0.4;
      ctx.strokeStyle = getCss('--neon'); ctx.globalAlpha = flash*0.65;
      ctx.lineWidth = thick*0.6*(flash);
      ctx.beginPath(); ctx.arc(CX,CY,rad,0,TAU); ctx.stroke();
      ctx.globalAlpha = 1; flash -= dt*2.2; if(flash<0) flash=0;
    }

    ctx.restore();
  }

  /* =========================
     SMYČKA
  ========================== */
  function tick(){ const t=now(); let dt=t-tPrev; tPrev=t; dt=Math.min(0.033,Math.max(0.001,dt)); render(dt); requestAnimationFrame(tick); }

  /* =========================
     INIT
  ========================== */
  resize(); render(0); requestAnimationFrame(tick);
  showHomeTitle();
  maybeShowHowto();
  updateHowtoPos();
  alignIdleLikeThis();


  // iOS/Chrome: první tap inicializuje AudioContext
  window.addEventListener('pointerdown', ()=>{ if(!actx){ try{ actx=new AudioCtx(); }catch(e){} } }, {once:true, passive:true});

  // ★ Pozastavit zvuky (WebAudio) při odchodu z appky
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      try { if (actx && actx.state === 'running') actx.suspend(); } catch(e){}
      // pozastav i hudbu
      if (typeof pauseMusic === 'function') pauseMusic();
    }
  }, { passive:true });

  // ★ Fallback pro iOS/Android při zavření/odchodu (BFCache apod.)
  window.addEventListener('pagehide', () => { if (typeof pauseMusic === 'function') pauseMusic(); }, { passive:true });

})();

/* =========================
   BACKGROUND MUSIC
========================== */
let bgMusic = null;
let fadeInterval = null;

function playMusic() {
  if (!bgMusic) {
    bgMusic = new Audio('music.mp3');
    bgMusic.loop = true;
    bgMusic.volume = 0.25; // tichá úroveň
  }
  // restartuj, pokud byla pauznutá
  if (bgMusic.paused) bgMusic.play().catch(()=>{});
}

function pauseMusic() { // ★ okamžité pauznutí bez resetu pozice
  if (!bgMusic) return;
  try {
    clearInterval(fadeInterval);
    fadeInterval = null;
    bgMusic.pause();
  } catch(e){}
}

function fadeOutMusic(duration = 1500) {
  if (!bgMusic) return;
  const startVol = bgMusic.volume;
  const steps = 30;
  const stepTime = duration / steps;
  let i = 0;
  clearInterval(fadeInterval);
  fadeInterval = setInterval(() => {
    i++;
    bgMusic.volume = Math.max(0, startVol * (1 - i / steps));
    if (i >= steps) {
      clearInterval(fadeInterval);
      fadeInterval = null;                 // ★
      bgMusic.pause();
      bgMusic.currentTime = 0;             // reset pozice po GAME OVER
      bgMusic.volume = startVol;           // připrav pro další hru
    }
  }, stepTime);
}

function fadeInMusic(duration = 1200) {
  if (!bgMusic) return;
  bgMusic.volume = 0;
  bgMusic.play().catch(()=>{});
  const targetVol = 0.3;
  const steps = 30;
  const stepTime = duration / steps;
  let i = 0;
  clearInterval(fadeInterval);
  fadeInterval = setInterval(() => {
    i++;
    bgMusic.volume = Math.min(targetVol, (targetVol * i) / steps);
    if (i >= steps) { clearInterval(fadeInterval); fadeInterval = null; } // ★
  }, stepTime);
}

</script>
</body>
</html>
